<!DOCTYPE html>
<html lang="en">
<head>
  <title>Pro Games</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Pro Games is a gaming hub with quick access to popular games.">

  <link rel="shortcut icon" href="fav.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
  <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
        --bg-dark: #111217;
        --bg-light: #1a1b22;
        --text-primary: #f0f0f5;
        --text-secondary: #a0a0b0;
        --accent-primary: #8e44ad;
        --accent-dark: #7c4dff;
        --accent-secondary: #c0392b;
        --glow-color: rgba(142, 68, 173, 0.7);
        --border-color: #2c2d3a;
        --font-family: 'Poppins', sans-serif;
    }

    body {
        font-family: var(--font-family);
        background: var(--bg-dark);
        color: var(--text-primary);
        padding: 20px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden; /* Prevent horizontal scroll from glow */
    }

    /* Add background glows for depth */
    body::before, body::after {
        content: '';
        position: fixed;
        width: 50vmax;
        height: 50vmax;
        border-radius: 50%;
        z-index: -1;
        filter: blur(100px);
        opacity: 0.15;
    }
    body::before {
        top: -20vmax;
        right: -20vmax;
        background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
    }
    body::after {
        bottom: -20vmax;
        left: -20vmax;
        background: radial-gradient(circle, #3498db 0%, transparent 70%);
    }

    /* --- NAV & USER SYSTEM STYLES --- */
    nav {
        background-color: rgba(10, 10, 10, 0.8);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(142, 68, 173, 0.2);
        position: sticky;
        top: 0;
        z-index: 1000;
        margin: -20px -20px 20px -20px; /* Offset body padding */
    }
    .logo {
        font-size: 1.5rem;
        font-weight: 800;
        letter-spacing: -0.5px;
        background: linear-gradient(45deg, var(--accent-primary), #3498db);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .btn-nav {
        color: var(--text-primary);
        text-decoration: none;
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        background-color: rgba(255, 255, 255, 0.1);
        transition: all 0.2s;
        font-size: 0.9rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
    }
    .btn-nav:hover {
        background-color: var(--accent-primary);
        color: #fff;
        box-shadow: 0 0 15px var(--glow-color);
    }
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: var(--bg-light);
        padding: 2rem;
        border-radius: 16px;
        width: 90%;
        max-width: 400px;
        border: 1px solid var(--border-color);
        box-shadow: 0 0 30px rgba(0,0,0,0.5);
        position: relative;
        text-align: center;
    }
    .close-modal {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
    }
    .close-modal:hover { color: var(--text-primary); }
    .profile-large-img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-bottom: 1rem;
        border: 3px solid var(--accent-primary);
    }
    .btn-action {
        background: linear-gradient(45deg, var(--accent-dark), var(--accent-primary));
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 50px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        margin-top: 1rem;
        transition: transform 0.2s;
    }
    .btn-action:hover {
        transform: scale(1.05);
    }
    #user-profile {
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 50px;
        transition: background 0.2s;
    }
    #user-profile:hover {
        background: rgba(255,255,255,0.1);
    }

    /* --- UTILITY & SHARED BUTTON STYLES --- */
    .fixed-btn {
        position: fixed;
        padding: 10px 18px;
        font-size: 0.9rem;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        z-index: 9999;
        transition: all 0.2s ease-in-out;
        background: var(--bg-light);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
    .fixed-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        border-color: var(--accent-primary);
    }

    #backToTopBtn { bottom: 20px; right: 20px; display: none; /* Hidden by default */ }

    /* --- HEADER & SEARCH --- */
    .header { text-align: center; margin-bottom: 10px; margin-top: 20px; }
    .header h1 {
        font-size: 3rem;
        font-weight: 700;
        background: linear-gradient(90deg, var(--accent-primary), #3498db);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 30px rgba(142, 68, 173, 0.3);
        margin: 20px 0 40px;
    }

    .search-filter-bar {
        width: 100%;
        max-width: 900px;
        margin: 20px auto 40px;
        display: flex;
        gap: 15px;
    }
    .random-game-btn {
        padding: 12px 20px;
        background: var(--accent-primary);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
        white-space: nowrap;
    }
    .random-game-btn:hover { background: #9b59b6; }

    .search-filter-bar input, .search-filter-bar select {
        flex: 1;
        padding: 12px 15px;
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 1rem;
        transition: border-color 0.2s ease;
    }
    .search-filter-bar input:focus, .search-filter-bar select:focus {
        outline: none;
        border-color: var(--accent-primary);
    }

    .game-stats {
        max-width: 900px;
        margin: -20px auto 30px;
        text-align: right;
        color: var(--text-secondary);
        font-size: 0.9rem;
        padding-right: 5px;
    }

    .game-tag {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--accent-primary);
        color: white;
        padding: 3px 8px;
        border-radius: 5px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 2;
    }

    .game-card .genre-tag {
        position: absolute;
        top: 10px; left: 10px;
        background: rgba(0,0,0,0.6);
        color: #fff; padding: 3px 8px; border-radius: 5px;
        font-size: 0.8rem; font-weight: 500; z-index: 2;
        opacity: 0; transition: opacity 0.2s ease;
    }
    .game-card:hover .genre-tag { opacity: 1; }
    .grid-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 50px 0 10px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--border-color);
    }

    /* --- GAME GRID --- */
    .game-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 30px;
        margin: 30px auto;
        max-width: 1400px;
    }
    .game-card {
        position: relative;
        background: var(--bg-light);
        border-radius: 14px;
        overflow: hidden;
        aspect-ratio: 5 / 7;
        cursor: pointer;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        border: 1px solid var(--border-color);
    }
    .game-card:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 0 25px var(--glow-color);
        border-color: var(--accent-primary);
    }

    .game-card img { width: 100%; height: 100%; object-fit: cover; }
    .game-card .title {
        position: absolute;
        bottom: 0;
        width: 100%;
        padding: 12px 10px;
        background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        text-align: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    /* --- FOOTER --- */
    .footer { margin-top: 80px; padding-top: 40px; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-secondary); }
    .footer h2 { font-size: 1.2rem; margin-bottom: 10px; color: var(--text-primary); }
    .footer ul { list-style: none; padding: 0; line-height: 1.8; }
    .footer .copyright { margin-top: 30px; font-size: 0.9rem; }
  </style>
</head>
<body>

<nav>
    <div class="logo">Pro Games 2.0</div>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <button id="music-btn" class="btn-nav" onclick="toggleMusic()">üîá Music</button>
        <button id="sync-btn" class="btn-nav" style="display: none;" onclick="enableCloudSave()">‚òÅÔ∏è Connect Cloud</button>
        <div id="user-profile" style="display: flex; align-items: center; gap: 0.5rem;" onclick="openProfileModal()"></div>
        <a href="index.html" class="btn-nav" onclick="localStorage.removeItem('user_credential'); localStorage.removeItem('google_access_token'); localStorage.removeItem('token_expiry');">Sign Out</a>
    </div>
</nav>

<button id="backToTopBtn" class="fixed-btn">Back to Top</button>

<div class="header"><h1>Pro Games</h1></div>

<audio id="bg-music" loop src="https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Tours/Enthusiast/Tours_-_01_-_Enthusiast.mp3"></audio>

<div class="search-filter-bar">
  <input type="text" id="searchInput" placeholder="Search games...">
  <select id="genreFilter">
    <option value="all">All Genres</option>
    <option value="arcade">Arcade</option>
    <option value="action">Action</option>
    <option value="puzzle">Puzzle</option>
    <option value="strategy">Strategy</option>
    <option value="adventure">Adventure</option>
    <option value="sports">Sports</option>
  </select>
  <button class="random-game-btn" id="randomGameBtn">Random Game</button>
</div>

<div class="game-grid" id="gameGrid"></div>

<div class="footer">
  <h2>Recommended Browsers</h2>
  <p>For best performance use:</p>
  <ul>
    <li>Microsoft Edge</li>
    <li>Opera GX</li>
    <li>Google Chrome</li>
  </ul>
  <div class="copyright">
      &copy; 2024 Pro Games. All rights reserved.
      <p>Last Updated: <span id="lastUpdated"></span></p>
      <div class="legal-links">
        <div>
          <a href="https://pro-games.pages.dev/privacy.html">Privacy Policy</a> |
          <a href="https://pro-games.pages.dev/terms.html">Terms & Conditions</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div id="profile-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <span class="close-modal" onclick="closeProfileModal()">&times;</span>
        <div id="modal-profile-info">
            <!-- Populated by JS -->
        </div>
        <hr style="border-color: rgba(255,255,255,0.1); margin: 1.5rem 0;">
        <h3>Data Management</h3>
        <button class="btn-action" onclick="exportGameData()">üì• Export Save Data</button>
        <button class="btn-action" onclick="document.getElementById('import-file').click()" style="margin-top: 0.5rem; background: linear-gradient(45deg, #4a148c, #7b1fa2);">üì§ Import Save Data</button>
        <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importGameData(this)">
        <hr style="border-color: rgba(255,255,255,0.1); margin: 1.5rem 0;">
        <div id="cloud-controls" style="display:none;"></div>
    </div>
</div>

<script>
/* ---------------- GAMES ---------------- */
const games = [
    { title: "Crossy Road", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/crossyroad.png", url: "games/crossyroad/crossyroad.html", genre: "arcade", tags: [] },
    { title: "Minecraft", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/minecraft.png", url: "games/minecraft/minecraft.html", genre: "adventure", tags: [] },
    { title: "Block Towers", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/block.png", url: "games/block/block.html", genre: "puzzle", tags: [] },
    { title: "Snake", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/snake.png", url: "games/snake/snake.html", genre: "arcade", tags: [] },
    { title: "Subway Surfers", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/subway.png", url: "games/subway/subway.html", genre: "arcade", tags: [] },
    { title: "Among Us", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/among.png", url: "games/among/among.html", genre: "strategy", tags: [] },
    { title: "Chess", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/chess.png", url: "games/chess/chess.html", genre: "strategy", tags: [] },
    { title: "FNAF", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/fnaf.png", url: "games/fnaf/fnaf.html", genre: "strategy", tags: [] },
    { title: "BitLife", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/bit.png", url: "games/bit/bit.html", genre: "strategy", tags: [] },
    { title: "Tomb of the Mask", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/tomb.png", url: "games/tomb/tomb.html", genre: "arcade", tags: [] },
    { title: "Slope", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/slope.png", url: "games/slope/slope.html", genre: "arcade", tags: [] },
    { title: "Grow a Garden", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/grow.png", url: "games/grow/grow.html", genre: "puzzle", tags: [] },
    { title: "Hill Climb Racing", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/hill.png", url: "games/hill/hill.html", genre: "arcade", tags: [] },
    { title: "1v1 LOL", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/lol.png", url: "games/lol/lol.html", genre: "action", tags: [] },
    { title: "Monkey Mart", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/monkey.png", url: "games/monkey/monkey.html", genre: "strategy", tags: [] },
    { title: "Temple Run", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/temple.png", url: "games/temple/temple.html", genre: "arcade", tags: [] },
    { title: "Zombie Road", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/zombie.png", url: "games/zombie/zombie.html", genre: "action", tags: [] },
    { title: "Zombie Rush", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/zombie2.png", url: "games/zombie2/zombie2.html", genre: "action", tags: [] },
    { title: "99 Nights in the Forest", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/99.png", url: "games/99/99.html", genre: "adventure", tags: [] },
    { title: "Escape Road", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/escape.png", url: "games/escape/escape.html", genre: "puzzle", tags: [] },
    { title: "Drive Mad", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/drive.png", url: "games/drive/drive.html", genre: "puzzle", tags: [] },
    { title: "8 Ball Pool", img: "https://raw.githubusercontent.com/JNathan34/Pro-Games/main/images/8.png", url: "games/8/8.html", genre: "sports", tags: [] }
];

// Bypass auth for all games since TFA is removed
localStorage.setItem("authenticated", "true");
localStorage.setItem("authExpires", Date.now() + 31536000000000); // 1000 years

const grid = document.getElementById("gameGrid");

function createGameCard(game) {
    const card = document.createElement("a");
    card.href = game.url;
    card.className = "game-card";

    const genre = game.genre.charAt(0).toUpperCase() + game.genre.slice(1);
    const tagsHTML = `<div class="genre-tag">${genre}</div>`;

    card.innerHTML = `${tagsHTML}<img src="${game.img}" alt="${game.title}"><div class="title">${game.title}</div>`;
    return card;
}

function renderGames(){
    const searchInput = document.getElementById("searchInput");
    const genreFilter = document.getElementById("genreFilter");

    const search = searchInput.value.toLowerCase();
    const filter = genreFilter.value;

    // Save search and filter to session storage
    sessionStorage.setItem('gameSearch', search);
    sessionStorage.setItem('gameFilter', filter);

    grid.innerHTML="";
    const filteredGames = games
        .filter(g => g.title.toLowerCase().includes(search))
        .filter(g => filter === "all" || g.genre === filter);

    filteredGames.forEach(g => grid.appendChild(createGameCard(g)));

}

// Restore search/filter from session storage and render
document.getElementById("searchInput").value = sessionStorage.getItem('gameSearch') || '';
document.getElementById("genreFilter").value = sessionStorage.getItem('gameFilter') || 'all';

document.getElementById("searchInput").addEventListener("input",renderGames);
document.getElementById("genreFilter").addEventListener("change",renderGames);
renderGames();

/* ---------------- BACKGROUND MUSIC ---------------- */
const bgMusic = document.getElementById('bg-music');
const musicBtn = document.getElementById('music-btn');
bgMusic.volume = 0.3; // Set volume to 30%

function toggleMusic() {
    if (bgMusic.paused) {
        bgMusic.play().then(() => {
            musicBtn.innerText = "üîä Music";
            musicBtn.style.background = "var(--accent-primary)";
            localStorage.setItem('bg_music_enabled', 'true');
        }).catch(e => console.log("Audio play failed:", e));
    } else {
        bgMusic.pause();
        musicBtn.innerText = "üîá Music";
        musicBtn.style.background = "rgba(255, 255, 255, 0.1)";
        localStorage.setItem('bg_music_enabled', 'false');
    }
}

/* ---------------- RANDOM GAME ---------------- */
document.getElementById("randomGameBtn").addEventListener("click", () => {
    const randomGame = games[Math.floor(Math.random() * games.length)];
    window.location.href = randomGame.url;
});

/* ---------------- FOOTER ---------------- */
document.getElementById('lastUpdated').textContent = new Date(document.lastModified).toLocaleDateString();

/* ---------------- BACK TO TOP BUTTON ---------------- */
const backToTopBtn = document.getElementById('backToTopBtn');

window.onscroll = () => {
    if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
        backToTopBtn.style.display = "block";
    } else {
        backToTopBtn.style.display = "none";
    }
};

backToTopBtn.onclick = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

/* ---------------- GOOGLE LOGIN & CLOUD SAVE ---------------- */
// Check for user credential
const credential = localStorage.getItem('user_credential');
const profileDiv = document.getElementById('user-profile');
const syncBtn = document.getElementById('sync-btn');

// Google Drive API Configuration
const CLIENT_ID = '448742201910-98bfqv6ugof15tgdk09mjap1kmgt89lt.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
let tokenClient;

if (credential) {
    try {
        // Decode JWT payload (Base64Url -> Base64 -> JSON)
        const payload = JSON.parse(atob(credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
        profileDiv.innerHTML = `
            <span>${payload.name}</span>
            <img src="${payload.picture}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%;">
        `;
        syncBtn.style.display = 'block';
    } catch (e) {
        renderGuestProfile();
    }
} else {
    renderGuestProfile();
}

function renderGuestProfile() {
    const gName = localStorage.getItem('guest_name');
    const gAvatar = localStorage.getItem('guest_avatar');
    if (gName) {
        const imgTag = gAvatar ? `<img src="${gAvatar}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : '';
        profileDiv.innerHTML = `<span>${gName}</span>${imgTag}`;
    } else {
        profileDiv.innerHTML = '<span>Guest User</span>';
    }
}

function gapiLoaded() {
    gapi.load('client', async () => {
        await gapi.client.init({
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        });
        restoreSession();
    });
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
            if (resp.error !== undefined) {
                throw (resp);
            }
            const expiry = Date.now() + (resp.expires_in * 1000);
            localStorage.setItem('google_access_token', resp.access_token);
            localStorage.setItem('token_expiry', expiry);

            syncBtn.innerText = "‚òÅÔ∏è Synced";
            syncBtn.style.backgroundColor = "#2e7d32";
            console.log("Cloud Save Enabled. Access Token acquired.");
            
            // Apply token immediately if GAPI is ready
            if (typeof gapi !== 'undefined' && gapi.client && gapi.client.drive) {
                gapi.client.setToken({access_token: resp.access_token});
                loadCloudSave();
            }
        },
    });

    // Auto-connect if user is signed in
    if (localStorage.getItem('user_credential') && !localStorage.getItem('google_access_token')) {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function restoreSession() {
    const token = localStorage.getItem('google_access_token');
    const expiry = localStorage.getItem('token_expiry');
    if (token && expiry && Date.now() < parseInt(expiry)) {
        gapi.client.setToken({access_token: token});
        syncBtn.innerText = "‚òÅÔ∏è Synced";
        syncBtn.style.backgroundColor = "#2e7d32";
        loadCloudSave(); // Load data when session is restored
    }
}

function enableCloudSave() {
    if (tokenClient) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    }
}

async function loadCloudSave(manual = false) {
    if(manual && !confirm("This will overwrite your local progress with data from the Cloud. Are you sure?")) return;
    
    const btn = document.getElementById('btn-download-cloud');
    if(btn) btn.innerText = "‚è≥ Downloading...";

    try {
        console.log("Checking for cloud saves...");
        const response = await gapi.client.drive.files.list({
            spaces: 'appDataFolder',
            q: "name = 'pro_games_save.json'",
            fields: 'files(id, modifiedTime)'
        });
        
        const files = response.result.files;
        if (files && files.length > 0) {
            const fileId = files[0].id;
            const fileContent = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            const data = fileContent.result;
            const saveData = (typeof data === 'string') ? JSON.parse(data) : data;
            
            for (const key in saveData) {
                localStorage.setItem(key, saveData[key]);
            }
            console.log('Cloud save loaded successfully.');
            
            // Visual feedback
            const syncBtn = document.getElementById('sync-btn');
            if(syncBtn) {
                const originalText = syncBtn.innerText;
                syncBtn.innerText = "‚òÅÔ∏è Data Loaded";
                setTimeout(() => syncBtn.innerText = originalText, 3000);
            }
            
            if(manual) {
                alert("‚úÖ Data Loaded from Cloud! The page will now reload.");
                window.location.reload();
            }
        } else {
            console.log('No cloud save found.');
            if(manual) alert("‚ö†Ô∏è No cloud save found.");
        }
    } catch (err) {
        console.error('Error loading cloud save:', err);
        if(manual) alert("‚ùå Download Failed: " + err.message);
    } finally {
        if(btn) btn.innerText = "‚òÅÔ∏è Force Load from Cloud";
    }
}

async function uploadToCloud() {
    if(!confirm("This will overwrite your Cloud Save with your current local progress. Are you sure?")) return;
    
    const btn = document.getElementById('btn-upload-cloud');
    if(btn) btn.innerText = "‚è≥ Uploading...";

    try {
        const data = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if(key !== 'google_access_token' && key !== 'user_credential' && key !== 'token_expiry') {
                data[key] = localStorage.getItem(key);
            }
        }
        const fileContent = JSON.stringify(data);
        const fileMetadata = {
            'name': 'pro_games_save.json',
            'mimeType': 'application/json',
            'parents': ['appDataFolder']
        };

        const response = await gapi.client.drive.files.list({
            spaces: 'appDataFolder',
            q: "name = 'pro_games_save.json'",
            fields: 'files(id)'
        });

        const files = response.result.files;

        if (files && files.length > 0) {
            const fileId = files[0].id;
            await gapi.client.request({
                path: '/upload/drive/v3/files/' + fileId,
                method: 'PATCH',
                params: { uploadType: 'media' },
                body: fileContent
            });
        } else {
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
            form.append('file', new Blob([fileContent], { type: 'application/json' }));

            await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                body: form
            });
        }
        
        alert("‚úÖ Saved to Cloud Successfully!");
    } catch (e) {
        console.error(e);
        alert("‚ùå Upload Failed: " + e.message);
    } finally {
        if(btn) btn.innerText = "‚òÅÔ∏è Force Save to Cloud";
    }
}

function updateAvatarPreview(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('guest-avatar-preview');
            if (preview.tagName === 'DIV') {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.id = 'guest-avatar-preview';
                img.className = 'profile-large-img';
                img.style.objectFit = 'cover';
                img.style.cursor = 'pointer';
                img.onclick = function() { document.getElementById('guest-avatar-input').click(); };
                preview.parentNode.replaceChild(img, preview);
            } else {
                preview.src = e.target.result;
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function saveGuestProfile() {
    const nameInput = document.getElementById('guest-name-input');
    const avatarInput = document.getElementById('guest-avatar-input');
    
    if (nameInput) localStorage.setItem('guest_name', nameInput.value);
    
    if (avatarInput && avatarInput.files && avatarInput.files[0]) {
        const file = avatarInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_SIZE = 150; // Resize to save space
                let width = img.width;
                let height = img.height;
                
                if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } }
                else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                try {
                    localStorage.setItem('guest_avatar', canvas.toDataURL('image/jpeg', 0.8));
                    alert("Profile saved!");
                    window.location.reload();
                } catch(err) { alert("Storage full or error saving image."); }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        alert("Profile saved!");
        window.location.reload();
    }
}

function openProfileModal() {
    const modal = document.getElementById('profile-modal');
    const infoDiv = document.getElementById('modal-profile-info');
    const cloudDiv = document.getElementById('cloud-controls');
    const credential = localStorage.getItem('user_credential');
    
    let html = '';
    if (credential) {
        try {
            const payload = JSON.parse(atob(credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
            html = `
                <img src="${payload.picture}" class="profile-large-img">
                <h2>${payload.name}</h2>
                <p style="color: var(--text-secondary)">${payload.email}</p>
            `;
            // Show cloud controls if logged in
            cloudDiv.style.display = 'block';
            cloudDiv.innerHTML = `
                <h3>Cloud Sync</h3>
                <button id="btn-upload-cloud" class="btn-action" onclick="uploadToCloud()" style="background: linear-gradient(45deg, #2e7d32, #4caf50);">‚òÅÔ∏è Force Save to Cloud</button>
                <button id="btn-download-cloud" class="btn-action" onclick="loadCloudSave(true)" style="margin-top: 0.5rem; background: linear-gradient(45deg, #0277bd, #039be5);">‚òÅÔ∏è Force Load from Cloud</button>
            `;
        } catch(e) {
            renderGuestModalContent();
        }
    } else {
        renderGuestModalContent();
    }
    
    function renderGuestModalContent() {
        const gName = localStorage.getItem('guest_name') || 'Guest User';
        const gAvatar = localStorage.getItem('guest_avatar');
        const avatarHtml = gAvatar ? 
            `<img src="${gAvatar}" id="guest-avatar-preview" class="profile-large-img" style="object-fit: cover; cursor: pointer;" onclick="document.getElementById('guest-avatar-input').click()" title="Click to change picture">` : 
            `<div id="guest-avatar-preview" class="profile-large-img" style="background: #333; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem auto; font-size: 2rem; cursor: pointer;" onclick="document.getElementById('guest-avatar-input').click()" title="Click to change picture">üë§</div>`;
        
        html = `
            ${avatarHtml}
            <h2>${gName}</h2>
            <p style="color: var(--text-secondary)">Local Profile</p>
            <div style="margin-top: 1rem; text-align: left; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 5px;">Display Name</label>
                <input type="text" id="guest-name-input" value="${gName}" style="width: 100%; padding: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; border-radius: 4px;">
                <input type="file" id="guest-avatar-input" accept="image/*" style="display: none;" onchange="updateAvatarPreview(this)">
                <p style="font-size: 0.7rem; color: var(--text-secondary); text-align: center; margin-bottom: 10px;">(Click avatar to change picture)</p>
                <button class="btn-action" onclick="saveGuestProfile()" style="margin-top: 5px; background: linear-gradient(45deg, var(--accent-primary), var(--accent-dark));">üíæ Save Profile</button>
            </div>
        `;
        cloudDiv.style.display = 'none';
    }
    
    infoDiv.innerHTML = html;
    modal.style.display = 'flex';
}

function closeProfileModal() {
    document.getElementById('profile-modal').style.display = 'none';
}

function exportGameData() {
    const data = {};
    // Collect all local storage items
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        data[key] = localStorage.getItem(key);
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pro_games_backup_' + new Date().toISOString().slice(0,10) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function importGameData(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            for (const key in data) {
                localStorage.setItem(key, data[key]);
            }
            alert('Game data imported successfully! The page will now reload.');
            window.location.reload();
        } catch (error) {
            alert('Error importing data: Invalid JSON file.');
        }
    };
    reader.readAsText(file);
}

window.onclick = function(event) {
    const modal = document.getElementById('profile-modal');
    if (event.target == modal) {
        closeProfileModal();
    }
}
</script>

</body>
</html>
