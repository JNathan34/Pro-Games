<!DOCTYPE html>
<html>

<head>
    <base href="https://cdn.jsdelivr.net/gh/CoolDude2349/everything@main/zombierush/">
    <meta charset="UTF-8">
    <title>Zombie Rush</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex">
    <meta name="generator" content="Scirra Construct">
    <meta name="author" content="Thomas COLLIN">
    <meta name="description" content="Zombie Rush is a survival game">

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <script>
        if (location.protocol.substr(0, 4) === "file") {
            alert("Web exports won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)");
        }
    </script>
    <script src="GameAnalytics.js"></script>
    <script src="sdk.js"></script>
    <noscript>
        <div id="notSupportedWrap">
            <h2 id="notSupportedTitle">This content requires JavaScript</h2>
            <p class="notSupportedMessage">JavaScript appears to be disabled. Please enable it to view this content.</p>
        </div>
    </noscript>
    <script src="scripts/supportcheck.js"></script>
    <script src="scripts/offlineclient.js" type="module"></script>
    <script src="scripts/main-edit3.js" type="module"></script>
    <script src="scripts/register-sw.js" type="module"></script>

<!-- CLOUD SAVE INTEGRATION -->
<script src="https://apis.google.com/js/api.js"></script>
<div id="save-indicator" onclick="saveAndExit()" title="Save & Exit" style="cursor: pointer; position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 8px 16px; border-radius: 20px; font-family: 'Segoe UI', sans-serif; font-size: 14px; font-weight: 500; display: none; z-index: 9999; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">☁️ Syncing...</div>

<script>
  const CLIENT_ID = '448742201910-98bfqv6ugof15tgdk09mjap1kmgt89lt.apps.googleusercontent.com';
  
  // Initialize Google API
  gapi.load('client', async () => {
      await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      });
      
      // Check for token from home.html
      const token = localStorage.getItem('google_access_token');
      const expiry = localStorage.getItem('token_expiry');
      
      if (token && expiry && Date.now() < parseInt(expiry)) {
          gapi.client.setToken({access_token: token});
          console.log("Game: Cloud Auth Active");
          
          const ind = document.getElementById('save-indicator');
          ind.style.display = 'block';
          ind.innerText = "☁️ Cloud Active";

          // Start auto-save loop (every 60 seconds)
          setInterval(saveToCloud, 60000);
          // Save on exit
          window.addEventListener('beforeunload', saveToCloud);
      }
  });

  async function saveToCloud() {
      const ind = document.getElementById('save-indicator');
      try {
          ind.innerText = "☁️ Syncing...";
          ind.style.display = 'block';
          ind.style.color = '#fff';

          // 1. Prepare Data
          const data = {};
          for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              // Filter out auth tokens to avoid bloating save file
              if(key !== 'google_access_token' && key !== 'user_credential' && key !== 'token_expiry') {
                  data[key] = localStorage.getItem(key);
              }
          }
          const fileContent = JSON.stringify(data);
          const fileMetadata = {
              'name': 'pro_games_save.json',
              'mimeType': 'application/json',
              'parents': ['appDataFolder']
          };

          // 2. Check if file exists
          const response = await gapi.client.drive.files.list({
              spaces: 'appDataFolder',
              q: "name = 'pro_games_save.json'",
              fields: 'files(id)'
          });

          const files = response.result.files;

          if (files && files.length > 0) {
              // Update existing file
              const fileId = files[0].id;
              await gapi.client.request({
                  path: '/upload/drive/v3/files/' + fileId,
                  method: 'PATCH',
                  params: { uploadType: 'media' },
                  body: fileContent
              });
          } else {
              // Create new file
              const form = new FormData();
              form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
              form.append('file', new Blob([fileContent], { type: 'application/json' }));

              await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                  method: 'POST',
                  headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                  body: form
              });
          }

          // Show indicator
          ind.innerText = "☁️ Saved";
          ind.style.color = '#4caf50';
          setTimeout(() => {
              ind.innerText = "☁️ Cloud Active";
              ind.style.color = '#fff';
          }, 3000);
          console.log("Game saved to cloud.");

      } catch (e) {
          console.error("Cloud Save Error:", e);
          ind.innerText = "⚠️ Sync Failed";
          ind.style.color = '#ff5252';
          setTimeout(() => {
              ind.innerText = "☁️ Cloud Active";
              ind.style.color = '#fff';
          }, 3000);
      }
  }

  async function saveAndExit() {
      const ind = document.getElementById('save-indicator');
      ind.innerText = "☁️ Saving...";
      await saveToCloud();
      window.location.href = '../../home.html';
  }
</script>

</body>

</html>
