<!-- Ultimate Game Stash file--> 
<!doctype html>
<html lang="en">

<head>
	<base href="https://cdn.jsdelivr.net/gh/genizy/monkey-mart-mobile@89836e4c54e87739ace84f6fe801b423185cc51d/">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="robots" content="noindex, nofollow">
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, minimal-ui, shrink-to-fit=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<title>Monkey Mart</title>

	<style>
		/* FIXED: removed position: fixed (breaks Defold input) */
		body {
			margin: 0;
			padding: 0;
			overflow: hidden;
			touch-action: none;
			background-color: #ffffff;
		}

		.canvas-app-container {
			width: 100%;
			height: 100%;
			position: absolute;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			background: #00BB61;
		}

		#canvas {
			outline: none;
			border: 0;
			width: 100%;
			vertical-align: bottom;
		}

		.canvas-app-canvas {
			background-repeat: no-repeat;
			background-position: top;
			background-size: cover;
			background-image: url("bg_loading.png");
		}

		.buttons-background {
			background-color: #ffffff;
			width: 100%;
			height: 42px;
		}

		.banner-styleBottom,
		.banner-styleTop {
			margin: 0 auto;
			position: fixed;
			display: block;
			left: 50%;
			transform: translateX(-50%);
		}

		.banner-styleBottom {
			bottom: 0;
		}

		.banner-styleTop {
			top: 0;
		}
	</style>

</head>

<body>

	<div id="app-container" class="canvas-app-container">
		<div id="canvas-container" class="canvas-app-canvas-container">
			<canvas id="canvas" class="canvas-app-canvas" tabindex="1" width="960" height="640"></canvas>
		</div>

		<div class="buttons-background"></div>

		<div id="progress-bar-root" style="position: absolute; bottom: 16%; left: 50%; visibility: hidden; z-index: 4;">
			<img id="progress-bar-bg" src="load_bar_bg.png">
			<img id="progress-bar-fg" src="load_bar_fg.png" style="position:absolute; clip: rect(0px,0px,0px,0px);">
		</div>
	</div>

	<script id="engine-loader" type="text/javascript" src="dmloader.js"></script>

	<script id="engine-setup" type="text/javascript">
		/* ORIGINAL ENGINE SETUP (unchanged) */
		var extra_params = {
			archive_location_filter: function (path) {
				return ("archive" + path + "");
			},
			engine_arguments: ["--verify-graphics-calls=false"],
			custom_heap_size: 134217728,
			full_screen_container: "#canvas-container",
			disable_context_menu: true
		};

		Module['INITIAL_MEMORY'] = extra_params.custom_heap_size;

		Module['onRuntimeInitialized'] = function () {
			Module.runApp("canvas", extra_params);
		};

		Module["locateFile"] = function (path, scriptDirectory) {
			if (path == "dmengine.wasm" || path == "dmengine_release.wasm" || path == "dmengine_headless.wasm") {
				path = "MonkeyMart.wasm";
			}
			return scriptDirectory + path;
		};

		var is_iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
		var buttonHeight = 0;
		var prevInnerWidth = -1;
		var prevInnerHeight = -1;

		function resize_game_canvas() {
			if (is_iOS) window.scrollTo(0, 0);

			var app_container = document.getElementById('app-container');
			var game_canvas = document.getElementById('canvas');
			var progress_bar_root = document.getElementById('progress-bar-root');
			var progress_bar_fg = document.getElementById('progress-bar-fg');
			var progress_bar_bg = document.getElementById('progress-bar-bg');

			var innerWidth = window.innerWidth;
			var innerHeight = window.innerHeight - buttonHeight;

			if (prevInnerWidth == innerWidth && prevInnerHeight == innerHeight) return;
			prevInnerWidth = innerWidth;
			prevInnerHeight = innerHeight;

			var width = innerWidth;
			var height = innerHeight;

			app_container.style.width = width + "px";
			app_container.style.height = height + buttonHeight + "px";
			game_canvas.width = width;
			game_canvas.height = height;

			var bar_h = Math.min(width, height);
			progress_bar_bg.width = Math.min(Math.ceil(bar_h * 0.06 * 300 / 24), width * 0.8);

			progress_bar_bg.style.marginLeft = - progress_bar_bg.width / 2 + "px";
			progress_bar_fg.width = Math.ceil(progress_bar_bg.width);

			progress_bar_fg.style.marginTop = "0px";
			progress_bar_fg.style.marginLeft = -progress_bar_bg.width / 2 - progress_bar_fg.width / 2 + "px";

			progress_bar_root.style.bottom = Math.ceil(height * 0.08 + buttonHeight) + "px";
		}

		resize_game_canvas();
		window.addEventListener('resize', resize_game_canvas, false);
		window.addEventListener('orientationchange', resize_game_canvas, false);
		window.addEventListener('focus', resize_game_canvas, false);
	</script>

	<script id="engine-start" type="text/javascript">
		/* ORIGINAL loader (unchanged) */
		var currentPercentage = 0;

		Progress.updateProgress = function (percentage) {
			Progress.notifyListeners(percentage);

			if (currentPercentage > percentage) {
				percentage = currentPercentage;
			}
			currentPercentage = percentage;

			var fg = document.getElementById('progress-bar-fg');
			fg.style.clip = "rect(0px," + fg.width * percentage / 100 + "px," + fg.height + "px,0px)";

			if (isNaN(percentage)) {
				document.getElementById('progress-bar-root').style.visibility = "hidden";
			}
		};

		Progress.addProgress = function () {
			document.getElementById('progress-bar-root').style.visibility = "visible";
		};

		Progress.removeProgress = function () {
			document.getElementById('progress-bar-root').style.visibility = "hidden";
			Module.canvas.style.background = "";
		};

		EngineLoader.stream_wasm = "false" === "true";
		EngineLoader.load("canvas", "MonkeyMart");
	</script>

	<!-- CLOUD SAVE INTEGRATION -->
	<script src="https://apis.google.com/js/api.js"></script>
	<div id="save-indicator" style="position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 8px 16px; border-radius: 20px; font-family: 'Segoe UI', sans-serif; font-size: 14px; font-weight: 500; display: none; z-index: 9999; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">☁️ Syncing...</div>
	<div id="save-indicator" style="position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 8px 16px; border-radius: 20px; font-family: 'Segoe UI', sans-serif; font-size: 14px; font-weight: 500; display: none; z-index: 2147483647; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">☁️ Syncing...</div>
	
	<script>
	  const CLIENT_ID = '448742201910-98bfqv6ugof15tgdk09mjap1kmgt89lt.apps.googleusercontent.com';
	  
	  // Initialize Google API
	  gapi.load('client', async () => {
		  await gapi.client.init({
			  discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
		  });
		  
		  // Check for token from home.html
		  const token = localStorage.getItem('google_access_token');
		  const expiry = localStorage.getItem('token_expiry');
		  
		  if (token && expiry && Date.now() < parseInt(expiry)) {
			  gapi.client.setToken({access_token: token});
			  console.log("Game: Cloud Auth Active");
			  
			  const ind = document.getElementById('save-indicator');
			  ind.style.display = 'block';
			  ind.innerText = "☁️ Cloud Active";

			  // Start auto-save loop (every 60 seconds)
			  setInterval(saveToCloud, 60000);
			  // Save on exit
			  window.addEventListener('beforeunload', saveToCloud);
		  } else {
			  console.log("Game: Cloud Auth Inactive (No token or expired)");
		  }
	  });
  
	  async function saveToCloud() {
		  const ind = document.getElementById('save-indicator');
		  try {
			  ind.innerText = "☁️ Syncing...";
			  ind.style.display = 'block';
			  ind.style.color = '#fff';
  
			  // 1. Prepare Data
			  const data = {};
			  for (let i = 0; i < localStorage.length; i++) {
				  const key = localStorage.key(i);
				  // Filter out auth tokens to avoid bloating save file
				  if(key !== 'google_access_token' && key !== 'user_credential' && key !== 'token_expiry') {
					  data[key] = localStorage.getItem(key);
				  }
			  }
			  const fileContent = JSON.stringify(data);
			  const fileMetadata = {
				  'name': 'pro_games_save.json',
				  'mimeType': 'application/json',
				  'parents': ['appDataFolder']
			  };
  
			  // 2. Check if file exists
			  const response = await gapi.client.drive.files.list({
				  spaces: 'appDataFolder',
				  q: "name = 'pro_games_save.json'",
				  fields: 'files(id)'
			  });
  
			  const files = response.result.files;
  
			  if (files && files.length > 0) {
				  // Update existing file
				  const fileId = files[0].id;
				  await gapi.client.request({
					  path: '/upload/drive/v3/files/' + fileId,
					  method: 'PATCH',
					  params: { uploadType: 'media' },
					  body: fileContent
				  });
			  } else {
				  // Create new file
				  const form = new FormData();
				  form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
				  form.append('file', new Blob([fileContent], { type: 'application/json' }));
  
				  await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
					  method: 'POST',
					  headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
					  body: form
				  });
			  }
  
			  // Show indicator
			  ind.innerText = "☁️ Saved";
			  ind.style.color = '#4caf50';
			  setTimeout(() => {
				  ind.innerText = "☁️ Cloud Active";
				  ind.style.color = '#fff';
			  }, 3000);
			  console.log("Game saved to cloud.");
  
		  } catch (e) {
			  console.error("Cloud Save Error:", e);
			  ind.innerText = "⚠️ Sync Failed";
			  ind.style.color = '#ff5252';
			  setTimeout(() => {
				  ind.innerText = "☁️ Cloud Active";
				  ind.style.color = '#fff';
			  }, 3000);
		  }
	  }
	</script>

</body>
</html>
