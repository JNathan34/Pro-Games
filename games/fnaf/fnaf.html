<!-- Ultimate Game Stash file--> 
<!-- For the regularly updating doc go to https://docs.google.com/document/d/1_FmH3BlSBQI7FGgAQL59-ZPe8eCxs35wel6JUyVaG8Q/ -->


<!DOCTYPE html>
<html lang="en">

<head>
    <base href="https://cdn.jsdelivr.net/gh/genizy/fnaf@latest/1/">
    <link rel="stylesheet" type="text/css" href="style.css"/>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densitydpi=device-dpi" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="HandheldFriendly" content="true" />
    <title>Five Nights at Freddy's 1</title>
</head>

<body>

    <div style="display: inline-block; -webkit-user-select: none; text-align: left">
        <canvas id="MMFCanvas" width="1280" height="720"> Your browser does not support Canvas, Please try again. </canvas>
    </div>
    <div id="progress-container">
        <div style="margin-bottom: 6px;">Downloading... <span id="download-text">0%</span></div>
        <div style="width: 100%; background: #444; border-radius: 6px; overflow: hidden;">
            <div id="download-bar" style="height: 10px; background: #3b82f6; width: 0%; transition: width 0.2s;"></div>
        </div>
        <div style="margin: 12px 0 6px;">Extracting... <span id="extract-text">0%</span></div>
        <div style="width: 100%; background: #444; border-radius: 6px; overflow: hidden;">
            <div id="extract-bar" style="height: 10px; background: #10b981; width: 0%; transition: width 0.2s;"></div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="main.js"></script>

<!-- CLOUD SAVE INTEGRATION -->
<script src="https://apis.google.com/js/api.js"></script>
<div id="save-indicator" onclick="saveAndExit()" title="Save & Exit" style="cursor: pointer; position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 8px 16px; border-radius: 20px; font-family: 'Segoe UI', sans-serif; font-size: 14px; font-weight: 500; display: none; z-index: 9999; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">☁️ Syncing...</div>

<script>
  const CLIENT_ID = '448742201910-98bfqv6ugof15tgdk09mjap1kmgt89lt.apps.googleusercontent.com';
  
  // Initialize Google API
  gapi.load('client', async () => {
      await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      });
      
      // Check for token from home.html
      const token = localStorage.getItem('google_access_token');
      const expiry = localStorage.getItem('token_expiry');
      
      if (token && expiry && Date.now() < parseInt(expiry)) {
          gapi.client.setToken({access_token: token});
          console.log("Game: Cloud Auth Active");
          
          const ind = document.getElementById('save-indicator');
          ind.style.display = 'block';
          ind.innerText = "☁️ Cloud Active";

          // Start auto-save loop (every 60 seconds)
          setInterval(saveToCloud, 60000);
          // Save on exit
          window.addEventListener('beforeunload', saveToCloud);
      }
  });

  async function saveToCloud() {
      const ind = document.getElementById('save-indicator');
      try {
          ind.innerText = "☁️ Syncing...";
          ind.style.display = 'block';
          ind.style.color = '#fff';

          // 1. Prepare Data
          const data = {};
          for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              // Filter out auth tokens to avoid bloating save file
              if(key !== 'google_access_token' && key !== 'user_credential' && key !== 'token_expiry') {
                  data[key] = localStorage.getItem(key);
              }
          }
          const fileContent = JSON.stringify(data);
          const fileMetadata = {
              'name': 'pro_games_save.json',
              'mimeType': 'application/json',
              'parents': ['appDataFolder']
          };

          // 2. Check if file exists
          const response = await gapi.client.drive.files.list({
              spaces: 'appDataFolder',
              q: "name = 'pro_games_save.json'",
              fields: 'files(id)'
          });

          const files = response.result.files;

          if (files && files.length > 0) {
              // Update existing file
              const fileId = files[0].id;
              await gapi.client.request({
                  path: '/upload/drive/v3/files/' + fileId,
                  method: 'PATCH',
                  params: { uploadType: 'media' },
                  body: fileContent
              });
          } else {
              // Create new file
              const form = new FormData();
              form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
              form.append('file', new Blob([fileContent], { type: 'application/json' }));

              await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                  method: 'POST',
                  headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                  body: form
              });
          }

          // Show indicator
          ind.innerText = "☁️ Saved";
          ind.style.color = '#4caf50';
          setTimeout(() => {
              ind.innerText = "☁️ Cloud Active";
              ind.style.color = '#fff';
          }, 3000);
          console.log("Game saved to cloud.");

      } catch (e) {
          console.error("Cloud Save Error:", e);
          ind.innerText = "⚠️ Sync Failed";
          ind.style.color = '#ff5252';
          setTimeout(() => {
              ind.innerText = "☁️ Cloud Active";
              ind.style.color = '#fff';
          }, 3000);
      }
  }

  async function saveAndExit() {
      const ind = document.getElementById('save-indicator');
      ind.innerText = "☁️ Saving...";
      await saveToCloud();
      
      // Navigate back to home.html ignoring <base> tag
      let path = window.location.href;
      path = path.substring(0, path.lastIndexOf('/')); // remove filename
      path = path.substring(0, path.lastIndexOf('/')); // remove game folder
      path = path.substring(0, path.lastIndexOf('/')); // remove games folder
      window.location.href = path + '/home.html';
  }
</script>

</body>

</html>
