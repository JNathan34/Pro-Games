<!DOCTYPE html>

<!-- Ultimate Game Stash file--> 
<!-- For the regularly updating doc go to https://docs.google.com/document/d/1_FmH3BlSBQI7FGgAQL59-ZPe8eCxs35wel6JUyVaG8Q/ -->

<html lang="en-us">
  <base href="https://cdn.jsdelivr.net/gh/abisdbest/classroom.google.com@45b2d69c626dc365753f6922d2c48c4075683ef5/drive.google.com/escape%20road/">
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Escape Road</title>
<link rel="shortcut icon" href="icon.png">
<link rel="stylesheet" href="TemplateData/style.css">
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init()</script>
</head>
<style>
  @font-face {
  font-family: myFirstFont;
  src: url(Chainwhacks.otf);
  }
  #logo-canvas, body {
    font-family: myFirstFont;
  }
</style>

<body class="dark">

<div id="unity-container" class="unity-desktop"><p style="opacity: 0;position: absolute;">_</p>
<canvas id="unity-canvas"></canvas>
</div>
<div id="loading-cover" style="display:none;background: black;">
<div id="unity-loading-bar">
<canvas id="logo-canvas" style="position: absolute; background-color: black;">
<img src="loading.png" id="ld_bg">
<img src="car-icon.png" id="ld_car">
</canvas>
</div>
</div>

<img id="azlogo" class="az" src="az_logo.png">
<script type="57480f3f31f76c75506c83a0-text/javascript">
    const container = document.querySelector("#unity-container");
    const canvas = document.querySelector("#unity-canvas");
    const loadingCover = document.querySelector("#loading-cover");
    const fullscreenButton = document.querySelector("#unity-fullscreen-button");

    const buildUrl = "TemplateData";
    const loaderUrl = buildUrl + "/loader.js";
    const config = {
      dataUrl: buildUrl + "/data.unityweb",
      frameworkUrl: buildUrl + "/framework.js.unityweb",
      codeUrl: buildUrl + "/wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "1games.io",
      productName: "Escape Road",
      productVersion: "2.0",
    };

    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      container.className = "unity-mobile";
      config.devicePixelRatio = 1;
    }
    
    function delay(ms) {
      return new Promise((resolve) => {
        setTimeout(() => resolve(), ms);
      });
    }

    async function load() {

      var az_logo = document.getElementById('azlogo');
      az_logo.style.opacity = 0;
      logo_loaded = true;

      az_logo.style.display = 'none';
      logo_loaded = false;
      
      createUnityInstance(canvas, config, (progress) => {
        logo_loading_percent = progress;
        drawCanvas(progress);
      }).then((unityInstance) => {
        window.unityInstance = unityInstance;
        setTimeout(() => {
          loadingCover.style.display = "none";
          logo_loaded = true;
          window.focus();
        }, 2000);
      }).catch((message) => {
        alert(message);
      });
    }

    loadingCover.style.display = "";

    var script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      load();
    };

    var logo_loaded = false;
    var logo_loading_percent = 0;

    window.onresize = () => {
      drawCanvas(logo_loading_percent);
    }
    window.onload = () => {
      drawCanvas(logo_loading_percent);
    }

    var logo_canvas = document.getElementById("logo-canvas");
    function drawCanvas(_percent = 0) {
      if (logo_loaded) {
        return;
      }
      resizeLogoCanvas();
      var ctx = logo_canvas.getContext("2d");
      var ld_bg = document.getElementById("ld_bg");
      var ld_car = document.getElementById("ld_car");

      var _sw = logo_canvas.width / 1920;
      var _sh = logo_canvas.height / 1080;

      if (_percent > 1) {
        _percent = 1;
      }

      ctx.drawImage(ld_bg, 0, 0, logo_canvas.width, logo_canvas.height);

      ctx.fillStyle = "#977e21";
      var _lw = 700;
      var _lh = 50;
      ctx.fillRect((1920 - _lw) * 0.5 * _sw, (1080 - 150) * _sh, _lw * _sw, _lh * _sh);

      ctx.fillStyle = "#fad234";
      var _pad = 5;
      var _pw = (_lw - _pad * 2);
      var _ph = _lh - _pad * 2;
      var _px = (1920 - _pw) * 0.5;
      ctx.fillRect(_px * _sw, (1080 - 150 + _pad) * _sh, _pw * _percent * _sw, _ph * _sh);

      ctx.font = "18px myFirstFont";
      const match = /(?<value>\d+\.?\d*)/;
      const setFontSize = (size) => ctx.font = ctx.font.replace(match, size);
      setFontSize(35 * _sh);
      ctx.textAlign = "center";
      ctx.fillStyle = "#fff";
      ctx.shadowColor = "black";
      ctx.shadowOffsetY = 2;
      var new_per = parseInt(_percent * 100);
      ctx.fillText("" + new_per + "%", logo_canvas.width / 2, logo_canvas.height / 2 + _sh * 425);
    }

    function resizeLogoCanvas() {
      var _w = window.innerWidth;
      var _h = window.innerHeight;
      var _nw = _h * 16 / 9;

      if (_nw <= _w) {
        logo_canvas.width = _nw;
        logo_canvas.height = _h;
      }
      else {
        logo_canvas.width = _w;
        logo_canvas.height = _w * 9 / 16;
      }
    }

    document.body.appendChild(script);
</script>

<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js" type="57480f3f31f76c75506c83a0-text/javascript"></script>
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js" type="57480f3f31f76c75506c83a0-text/javascript"></script>
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js" type="57480f3f31f76c75506c83a0-text/javascript"></script>
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-analytics-compat.js" type="57480f3f31f76c75506c83a0-text/javascript"></script>

<script type="57480f3f31f76c75506c83a0-module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-analytics.js";
  import { getAuth  } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC2RwMfh0GMuQMtQdijjUo-MEffB4N9xVY",
    authDomain: "escape-road-gm1.firebaseapp.com",
    projectId: "escape-road-gm1",
    storageBucket: "escape-road-gm1.appspot.com",
    messagingSenderId: "713881704715",
    appId: "1:713881704715:web:615cc93a73d9814b24ea0e",
    measurementId: "G-E8C3TNJE0S"
  };

  window.dataLayer = window.dataLayer || [];
  window.gtag = function(){dataLayer.push(arguments);}

  window.gtag("config", firebaseConfig.measurementId, {
      cookie_domain: location.hostname,
      cookie_flags: "SameSite=None;Secure",
  });

  const app = firebase.initializeApp(firebaseConfig);
  const auth = getAuth(app);
</script>

<script src="rocket-loader.min.js" data-cf-settings="57480f3f31f76c75506c83a0-|49" defer></script>

<!-- CLOUD SAVE INTEGRATION -->
<script src="https://apis.google.com/js/api.js"></script>
<div id="save-indicator" onclick="saveAndExit()" title="Save & Exit" style="cursor: pointer; position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 8px 16px; border-radius: 20px; font-family: 'Segoe UI', sans-serif; font-size: 14px; font-weight: 500; display: none; z-index: 9999; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">☁️ Syncing...</div>

<script>
  const CLIENT_ID = '448742201910-98bfqv6ugof15tgdk09mjap1kmgt89lt.apps.googleusercontent.com';
  
  // Initialize Google API
  gapi.load('client', async () => {
      await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      });
      
      // Check for token from home.html
      const token = localStorage.getItem('google_access_token');
      const expiry = localStorage.getItem('token_expiry');
      
      if (token && expiry && Date.now() < parseInt(expiry)) {
          gapi.client.setToken({access_token: token});
          console.log("Game: Cloud Auth Active");
          
          const ind = document.getElementById('save-indicator');
          ind.style.display = 'block';
          ind.innerText = "☁️ Cloud Active";

          // Start auto-save loop (every 60 seconds)
          setInterval(saveToCloud, 60000);
          // Save on exit
          window.addEventListener('beforeunload', saveToCloud);
      }
  });

  async function saveToCloud() {
      const ind = document.getElementById('save-indicator');
      try {
          ind.innerText = "☁️ Syncing...";
          ind.style.display = 'block';
          ind.style.color = '#fff';

          // 1. Prepare Data
          const data = {};
          for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              // Filter out auth tokens to avoid bloating save file
              if(key !== 'google_access_token' && key !== 'user_credential' && key !== 'token_expiry') {
                  data[key] = localStorage.getItem(key);
              }
          }
          const fileContent = JSON.stringify(data);
          const fileMetadata = {
              'name': 'pro_games_save.json',
              'mimeType': 'application/json',
              'parents': ['appDataFolder']
          };

          // 2. Check if file exists
          const response = await gapi.client.drive.files.list({
              spaces: 'appDataFolder',
              q: "name = 'pro_games_save.json'",
              fields: 'files(id)'
          });

          const files = response.result.files;

          if (files && files.length > 0) {
              // Update existing file
              const fileId = files[0].id;
              await gapi.client.request({
                  path: '/upload/drive/v3/files/' + fileId,
                  method: 'PATCH',
                  params: { uploadType: 'media' },
                  body: fileContent
              });
          } else {
              // Create new file
              const form = new FormData();
              form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
              form.append('file', new Blob([fileContent], { type: 'application/json' }));

              await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                  method: 'POST',
                  headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                  body: form
              });
          }

          // Show indicator
          ind.innerText = "☁️ Saved";
          ind.style.color = '#4caf50';
          setTimeout(() => {
              ind.innerText = "☁️ Cloud Active";
              ind.style.color = '#fff';
          }, 3000);
          console.log("Game saved to cloud.");

      } catch (e) {
          console.error("Cloud Save Error:", e);
          ind.innerText = "⚠️ Sync Failed";
          ind.style.color = '#ff5252';
          setTimeout(() => {
              ind.innerText = "☁️ Cloud Active";
              ind.style.color = '#fff';
          }, 3000);
      }
  }

  async function saveAndExit() {
      const ind = document.getElementById('save-indicator');
      ind.innerText = "☁️ Saving...";
      await saveToCloud();
      
      // Navigate back to home.html ignoring <base> tag
      let path = window.location.href;
      path = path.substring(0, path.lastIndexOf('/')); // remove filename
      path = path.substring(0, path.lastIndexOf('/')); // remove game folder
      path = path.substring(0, path.lastIndexOf('/')); // remove games folder
      window.location.href = path + '/home.html';
  }
</script>

</body>
</html>
